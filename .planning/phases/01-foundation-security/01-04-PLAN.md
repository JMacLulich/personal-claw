---
phase: 01-foundation-security
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - src/token_manager.py
  - scripts/test_gmail.py
  - README.md
autonomous: false
user_setup:
  - service: google-cloud
    why: "OAuth flow requires Google credentials"
    env_vars:
      - name: GMAIL_CREDENTIALS_PATH
        source: "Project root path to credentials.json"
      - name: GMAIL_TOKEN_PATH
        source: "Project root path to token.json"
  - service: discord
    why: "Discord token stored via .env"
    env_vars:
      - name: DISCORD_BOT_TOKEN
        source: "Discord Developer Portal -> Applications -> [Your App] -> Bot -> Token"
      - name: DISCORD_ALLOWLISTED_USER_ID
        source: "Discord -> User Settings -> Advanced -> Enable Developer Mode -> Right-click your user -> Copy ID"
must_haves:
  truths:
    - "Gmail OAuth flow creates or refreshes token.json"
    - "Discord token stored in .env and validated by config loader"
  artifacts:
    - path: "src/token_manager.py"
      provides: "Correct OAuth flow and token persistence"
    - path: "scripts/test_gmail.py"
      provides: "Manual OAuth bootstrap entrypoint"
    - path: "README.md"
      provides: "Minimal setup steps for Gmail + Discord tokens"
---

<objective>
Provide basic tooling to complete Gmail OAuth and store token.json, plus document Discord token storage.

Purpose: Establish minimal auth tooling before deeper bot integration, reducing confusion and surfacing setup gaps early.

Output: A simple, reliable Gmail OAuth bootstrap flow and clear documentation for storing Discord credentials.
</objective>

<execution_context>
@/Users/jasonmaclulich/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/jasonmaclulich/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Fix OAuth token flow and persistence</name>
  <files>
    src/token_manager.py
  </files>
  <action>
Update TokenManager to correctly run Gmail OAuth and save token.json:

1. Load existing token from token.json using Credentials.from_authorized_user_file
2. If token missing or invalid, run InstalledAppFlow from credentials.json
3. Save refreshed or newly created credentials to token.json
4. Keep read-only scope (gmail.readonly)
5. Ensure token path directory handling is safe when no directory is specified

Goal: OAuth flow should work reliably without requiring GmailClient integration.
  </action>
  <verify>
Run: `python scripts/test_gmail.py`
Expected: OAuth flow completes and token.json is saved
  </verify>
  <done>
TokenManager reliably creates and saves token.json from credentials.json
  </done>
</task>

<task type="auto">
  <name>Simplify Gmail OAuth bootstrap script</name>
  <files>
    scripts/test_gmail.py
  </files>
  <action>
Adjust the script to focus on OAuth bootstrap and token storage:

1. Use TokenManager directly (no inbox summary required)
2. Print clear success message with token.json path
3. Keep troubleshooting tips for missing credentials

Goal: One command that creates the token without requiring bot wiring.
  </action>
  <verify>
Run: `python scripts/test_gmail.py`
Expected: Prompts for OAuth on first run, then reports token saved
  </verify>
  <done>
scripts/test_gmail.py functions as a minimal OAuth bootstrap tool
  </done>
</task>

<task type="auto">
  <name>Document token storage locations</name>
  <files>
    README.md
  </files>
  <action>
Add a short “Basic Auth Tooling” section:

1. Copy .env.example to .env and set DISCORD_BOT_TOKEN + DISCORD_ALLOWLISTED_USER_ID
2. Place credentials.json in project root
3. Run `python scripts/test_gmail.py` to generate token.json
4. Note where token.json is stored and how to reset it

Keep it brief and focused on token setup only.
  </action>
  <verify>
Read README section to confirm steps are explicit and minimal
  </verify>
  <done>
README documents token setup steps without bot integration requirements
  </done>
</task>

</tasks>

<verification>
Overall checks:
- [ ] scripts/test_gmail.py completes OAuth and stores token.json
- [ ] TokenManager uses correct credentials.json -> token.json flow
- [ ] README explains where Discord and Gmail tokens live
</verification>

<success_criteria>
Phase 1 tooling step complete when:
1. Running scripts/test_gmail.py creates token.json successfully
2. Discord credentials are stored in .env and validated by config loader
3. Documentation clearly describes token setup in 4 steps or fewer
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-04-SUMMARY.md`
</output>
