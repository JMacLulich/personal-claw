---
phase: 01-foundation-security
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/gmail_client.py
  - src/token_manager.py
autonomous: true

must_haves:
  truths:
    - "Bot can authenticate with Gmail API"
    - "OAuth tokens are stored and automatically refreshed"
    - "Bot can read inbox messages"
  artifacts:
    - path: "src/gmail_client.py"
      provides: "Gmail API client"
      exports: ["GmailClient"]
      min_lines: 50
    - path: "src/token_manager.py"
      provides: "OAuth token management with auto-refresh"
      exports: ["TokenManager"]
  key_links:
    - from: "src/gmail_client.py"
      to: "src/token_manager.TokenManager"
      via: "token management delegation"
      pattern: "TokenManager\\("
    - from: "src/gmail_client.py"
      to: "googleapiclient.discovery.build"
      via: "Gmail service initialization"
      pattern: "build\\(['\"]gmail['\"]"
---

<objective>
Implement Gmail API integration with OAuth token management and automatic refresh.

Purpose: Establishes secure Gmail connection that can read inbox. Implements token health checks and auto-refresh per research findings.

Output: Working Gmail client that handles OAuth flow and maintains valid tokens automatically.
</objective>

<execution_context>
@/Users/jasonmaclulich/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/jasonmaclulich/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create OAuth token manager</name>
  <files>
    src/token_manager.py
  </files>
  <action>
Create `src/token_manager.py` with token lifecycle management:

Implement `TokenManager` class with:

1. `__init__(credentials_path, token_path)`:
   - Store paths for credentials.json and token.json
   - credentials.json = OAuth client ID from Google Cloud Console
   - token.json = stored access/refresh tokens

2. `get_credentials()` method:
   - If token.json exists:
     - Load existing credentials
     - Check if expired: `creds.expired`
     - If expired and refresh token exists: `creds.refresh(Request())`
     - Save refreshed token back to token.json
   - If no token.json:
     - Run OAuth flow using InstalledAppFlow
     - Scopes: ['https://www.googleapis.com/auth/gmail.readonly'] (read-only for Phase 1)
     - Save new token to token.json
   - Return valid credentials

3. `health_check()` method:
   - Returns True if credentials valid and not expired
   - Returns False if refresh needed
   - Use this for proactive token monitoring

Why this design:
- Follows research finding: "Gmail OAuth tokens require proactive health checks and automatic refresh"
- Encapsulates all token logic in one place
- Handles both initial OAuth and refresh transparently
- Fail-safe: automatically refreshes expired tokens

Critical: Use read-only scope (gmail.readonly) for Phase 1. Send capability comes later.
  </action>
  <verify>
Run: `python -c "from src.token_manager import TokenManager; print('TokenManager loaded')"`
  </verify>
  <done>
src/token_manager.py provides TokenManager class that handles OAuth flow, token storage, expiry checking, and automatic refresh
  </done>
</task>

<task type="auto">
  <name>Create Gmail client</name>
  <files>
    src/gmail_client.py
  </files>
  <action>
Create `src/gmail_client.py` with Gmail API wrapper:

Implement `GmailClient` class:

1. `__init__(config)`:
   - Accept Config instance
   - Create TokenManager with config.gmail_credentials_path and config.gmail_token_path
   - Initialize service as None (lazy load)

2. `_ensure_connected()` private method:
   - If service already exists, return
   - Get credentials from TokenManager
   - Build Gmail service: `build('gmail', 'v1', credentials=creds)`
   - Store service for reuse

3. `list_messages(max_results=10)` method:
   - Ensure connected
   - Call Gmail API: `service.users().messages().list(userId='me', maxResults=max_results)`
   - Return list of message IDs
   - Handle API errors gracefully (log and raise)

4. `get_message(message_id)` method:
   - Ensure connected
   - Call Gmail API: `service.users().messages().get(userId='me', id=message_id, format='full')`
   - Return full message object
   - Handle API errors

5. `get_inbox_summary()` method:
   - List recent messages
   - Return count and basic info
   - This is for testing connection

Why lazy connection (_ensure_connected):
- Don't hit Gmail API until needed
- TokenManager handles credential refresh
- Single point for service initialization

Error handling philosophy:
- Gmail API errors should surface (don't silently fail)
- Log all API calls for debugging
- Caller decides how to handle errors
  </action>
  <verify>
Run: `python -c "from src.gmail_client import GmailClient; print('GmailClient loaded')"`
  </verify>
  <done>
src/gmail_client.py provides GmailClient class with list_messages, get_message, and get_inbox_summary methods, using TokenManager for auth
  </done>
</task>

<task type="auto">
  <name>Test Gmail connection</name>
  <files>
    tests/test_gmail_client.py
    scripts/test_gmail.py
  </files>
  <action>
Create tests and manual verification script:

1. Create `tests/test_gmail_client.py`:
   - Test GmailClient initialization
   - Mock TokenManager and Gmail API service
   - Verify _ensure_connected creates service
   - Verify list_messages calls correct API endpoint
   - Use unittest.mock for API mocking

2. Create `scripts/test_gmail.py` for manual testing:
   - Load config
   - Create GmailClient
   - Try to get inbox summary
   - Print results or error
   - This script requires real credentials.json and user interaction for OAuth

Why both unit tests and manual script:
- Unit tests verify logic without real API calls
- Manual script confirms OAuth flow works end-to-end
- Manual testing happens after user sets up Google Cloud project

Note: Manual script will fail until credentials.json exists (expected - user setup required)
  </action>
  <verify>
Run: `python -m pytest tests/test_gmail_client.py -v`
Tests should pass with mocked API
  </verify>
  <done>
tests/test_gmail_client.py verifies Gmail client logic with mocks, scripts/test_gmail.py ready for manual OAuth testing
  </done>
</task>

</tasks>

<verification>
Overall checks:
- [ ] src/token_manager.py handles OAuth flow and token refresh
- [ ] src/gmail_client.py provides Gmail API wrapper
- [ ] Tests pass with mocked Gmail API
- [ ] Manual test script exists for OAuth verification
- [ ] Gmail API scope is read-only (gmail.readonly)
</verification>

<success_criteria>
1. TokenManager handles OAuth flow and automatic token refresh
2. GmailClient can list and retrieve messages
3. Tests verify client logic without live API
4. Manual test script ready for OAuth flow verification
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-03-SUMMARY.md`
</output>
