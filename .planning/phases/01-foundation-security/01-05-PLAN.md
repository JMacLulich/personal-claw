---
phase: 01-foundation-security
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03"]
files_modified:
  - src/bot.py
  - src/claw.py
  - personal-claw.service
  - scripts/deploy.sh
autonomous: false
user_setup:
  - service: discord
    why: "Bot requires Discord application token"
    env_vars:
      - name: DISCORD_BOT_TOKEN
        source: "Discord Developer Portal -> Applications -> [Your App] -> Bot -> Token"
      - name: DISCORD_ALLOWLISTED_USER_ID
        source: "Discord -> User Settings -> Advanced -> Enable Developer Mode -> Right-click your user -> Copy ID"
  - service: google-cloud
    why: "Gmail API access requires OAuth credentials"
    dashboard_config:
      - task: "Create Google Cloud project"
        location: "https://console.cloud.google.com"
      - task: "Enable Gmail API"
        location: "APIs & Services -> Enable APIs and Services -> Gmail API"
      - task: "Create OAuth 2.0 credentials"
        location: "APIs & Services -> Credentials -> Create Credentials -> OAuth client ID -> Desktop app"
      - task: "Download credentials.json"
        location: "Credentials page -> Download JSON for created OAuth client"

must_haves:
  truths:
    - "Discord bot and Gmail client work together"
    - "Bot can fetch inbox summary when asked"
    - "Service starts on boot and survives reboots"
    - "Only allowlisted user can trigger Gmail checks"
  artifacts:
    - path: "src/claw.py"
      provides: "Main application orchestrator"
      exports: ["PersonalClaw"]
    - path: "personal-claw.service"
      provides: "Systemd service definition"
      contains: "ExecStart"
    - path: "src/bot.py"
      provides: "Discord commands wired to Gmail"
      contains: "check_inbox"
  key_links:
    - from: "src/bot.py"
      to: "src/claw.PersonalClaw"
      via: "command handlers call claw methods"
      pattern: "claw\\.(check_inbox|get_summary)"
    - from: "src/claw.py"
      to: "src/gmail_client.GmailClient"
      via: "claw delegates to Gmail client"
      pattern: "GmailClient\\("
    - from: "personal-claw.service"
      to: "src/bot.py"
      via: "systemd executes bot"
      pattern: "python.*bot\\.py"
---

<objective>
Wire Discord bot to Gmail client and deploy as system service on N100 box.

Purpose: Completes Phase 1 integration - bot can check inbox on command and runs as reliable service.

Output: Working system service that responds to Discord commands with Gmail inbox data, enforces user allowlist, and survives reboots.
</objective>

<execution_context>
@/Users/jasonmaclulich/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/jasonmaclulich/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-security/01-02-SUMMARY.md
@.planning/phases/01-foundation-security/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create application orchestrator</name>
  <files>
    src/claw.py
  </files>
  <action>
Create `src/claw.py` as main application coordinator:

Implement `PersonalClaw` class:

1. `__init__(config)`:
   - Store config
   - Create GmailClient instance
   - Initialize any shared state

2. `check_inbox()` async method:
   - Call gmail_client.get_inbox_summary()
   - Return formatted summary string
   - Handle Gmail API errors (log and return user-friendly message)
   - Example return: "ðŸ“¬ You have 5 messages in your inbox"

3. `get_message_count()` method:
   - Quick count of unread messages
   - Return integer count
   - Used for status checks

Why orchestrator pattern:
- Discord bot handles UI (commands, responses)
- PersonalClaw handles business logic (what to do)
- GmailClient handles Gmail API (how to fetch)
- Clean separation of concerns
- Makes testing easier (mock PersonalClaw in bot tests)

Keep it simple for Phase 1 - just inbox summary capability. Future phases add email processing logic here.
  </action>
  <verify>
Run: `python -c "from src.claw import PersonalClaw; print('PersonalClaw loaded')"`
  </verify>
  <done>
src/claw.py provides PersonalClaw orchestrator with check_inbox and get_message_count methods
  </done>
</task>

<task type="auto">
  <name>Wire Discord commands to Gmail</name>
  <files>
    src/bot.py
  </files>
  <action>
Extend `src/bot.py` to add Gmail integration:

1. Import PersonalClaw from src.claw

2. Create PersonalClaw instance at bot startup:
   - In on_ready event or at module level
   - Pass loaded config to PersonalClaw

3. Add `/check-inbox` slash command:
   - `@bot.command()` decorator
   - Call `await claw.check_inbox()`
   - Respond with inbox summary
   - Handle errors gracefully (tell user if Gmail unavailable)
   - Remember: allowlist check runs automatically via @bot.check

4. Add `/status` command:
   - Shows bot is running
   - Shows message count from `claw.get_message_count()`
   - Example: "âœ… Personal-Claw is running. 5 messages in inbox."

Why these commands:
- `/check-inbox` proves Gmail integration works
- `/status` provides health check (useful for debugging service)
- Both are protected by global allowlist check

Keep responses friendly and calm (matches project tone - supportive/coaching).
  </action>
  <verify>
Run: `python -c "from src.bot import bot; import inspect; cmds = [c.name for c in bot.pending_application_commands]; print(cmds)"`
Should show check-inbox and status in commands list
  </verify>
  <done>
src/bot.py wired to PersonalClaw, /check-inbox and /status commands implemented
  </done>
</task>

<task type="auto">
  <name>Create systemd service</name>
  <files>
    personal-claw.service
    scripts/deploy.sh
    scripts/service-install.sh
  </files>
  <action>
Create service files for N100 deployment:

1. Create `personal-claw.service` systemd unit:
```ini
[Unit]
Description=Personal-Claw Discord Bot
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=jason
WorkingDirectory=/home/jason/personal-claw
Environment="PATH=/home/jason/personal-claw/venv/bin:/usr/bin"
EnvironmentFile=/home/jason/personal-claw/.env
ExecStart=/home/jason/personal-claw/venv/bin/python src/bot.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

2. Create `scripts/deploy.sh`:
   - Syncs code to N100 box via rsync
   - Excludes .git, .env, token.json, venv
   - Example: `rsync -av --exclude-from=.deployignore ./ n100alerts:~/personal-claw/`

3. Create `scripts/service-install.sh`:
   - Copies service file to /etc/systemd/system/
   - Reloads systemd daemon
   - Enables service (start on boot)
   - Starts service
   - Shows status
   - Must run on N100 box (not local)

Why this design:
- Follows research finding: "systemd service on Ubuntu with restart policy"
- `Restart=always` handles crashes
- `After=network-online.target` waits for network
- `EnvironmentFile` loads secrets from .env
- Structured logging via journalctl

Notes:
- Assumes N100 box accessible via SSH (user has Tailscale access)
- Assumes Python venv at ~/personal-claw/venv on N100
  </action>
  <verify>
Check files exist:
- personal-claw.service (systemd unit)
- scripts/deploy.sh (deployment script)
- scripts/service-install.sh (service installation)
  </verify>
  <done>
Systemd service file and deployment scripts created, ready for N100 installation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 integration: Discord bot with Gmail access control and system service setup.

Claude has automated:
- Application orchestrator (PersonalClaw) wiring bot to Gmail
- Discord commands (/check-inbox, /status) protected by allowlist
- Systemd service configuration with auto-restart
- Deployment scripts for N100 box
  </what-built>
  <how-to-verify>
**Required setup (one-time):**

1. **Get Discord credentials:**
   - Go to https://discord.com/developers/applications
   - Create new application (or use existing)
   - Go to Bot section, copy token
   - Enable Developer Mode in Discord (User Settings -> Advanced)
   - Right-click your username, Copy ID

2. **Get Gmail credentials:**
   - Go to https://console.cloud.google.com
   - Create new project (or use existing)
   - Enable Gmail API (APIs & Services -> Enable APIs)
   - Create OAuth 2.0 credentials (Desktop app type)
   - Download credentials.json to project root

3. **Configure environment:**
   - Copy .env.example to .env
   - Add DISCORD_BOT_TOKEN=<your token>
   - Add DISCORD_ALLOWLISTED_USER_ID=<your user ID>
   - Place credentials.json in project root

**Local testing:**

1. Run bot locally:
   ```bash
   python src/bot.py
   ```
   - First run will open browser for Gmail OAuth (sign in, grant read access)
   - Bot should print "Bot connected as [name]"

2. Test in Discord:
   - Send `/ping` - should respond "Pong! You're authorized."
   - Send `/status` - should show inbox count
   - Send `/check-inbox` - should show inbox summary
   - Have someone else try `/ping` - should reject with "Sorry, this bot is private."

3. Verify allowlist enforcement:
   - Try command from different Discord account
   - Should be rejected

**N100 deployment (when ready):**

1. Deploy code:
   ```bash
   ./scripts/deploy.sh
   ```

2. SSH to N100 and install service:
   ```bash
   ssh n100alerts
   cd ~/personal-claw
   sudo ./scripts/service-install.sh
   ```

3. Verify service:
   ```bash
   sudo systemctl status personal-claw
   journalctl -u personal-claw -f
   ```

4. Test reboot survival:
   ```bash
   sudo reboot
   # Wait for reboot, then check:
   sudo systemctl status personal-claw
   ```

**Expected results:**
- âœ… Bot responds to your commands only
- âœ… /check-inbox shows Gmail inbox summary
- âœ… Service starts after reboot
- âœ… Other users are rejected

**If issues:**
- Check logs: `journalctl -u personal-claw -n 50`
- Verify .env exists on N100
- Verify credentials.json exists on N100
- Check token.json was created (OAuth completed)
  </how-to-verify>
  <resume-signal>
Type "approved" when all tests pass, or describe any issues found
  </resume-signal>
</task>

</tasks>

<verification>
Overall checks:
- [ ] src/claw.py orchestrates Discord and Gmail
- [ ] src/bot.py has /check-inbox and /status commands
- [ ] personal-claw.service configured for systemd
- [ ] Deployment scripts exist (deploy.sh, service-install.sh)
- [ ] Local testing works (bot responds, Gmail accessible)
- [ ] Service survives reboot on N100 box
</verification>

<success_criteria>
Phase 1 complete when:
1. Discord bot responds only to Jason's allowlisted user ID
2. Bot can fetch Gmail inbox summary on command
3. Bot runs as systemd service on N100 box
4. Service automatically restarts after reboot
5. All Phase 1 success criteria from roadmap met
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-05-SUMMARY.md`
</output>
